INSERT INTO {{ params.stage_db }}.{{ params.stage_schema }}.{{ params.stage_table_exploded }}
SELECT
CLIENTID,
FULLVISITORID,
VISITORID,
USERID,
VISITNUMBER,
VISITID,
VISITSTARTTIME,
DATE,
TOTALS,
TOTALS_BOUNCES,
TOTALS_HITS,
TOTALS_NEWVISITS,
TOTALS_PAGEVIEWS,
TOTALS_SCREENVIEWS,
TOTALS_SESSIONQUALITYDIM,
TOTALS_TIMEONSCREEN,
TOTALS_TIMEONSITE,
TOTALS_TOTALTRANSACTIONREVENUE,
TOTALS_TRANSACTIONREVENUE,
TOTALS_TRANSACTIONS,
TOTALS_UNIQUESCREENVIEWS,
TOTALS_VISITS,
TRAFFICSOURCE,
TRAFFICSOURCE_ADCONTENT,
TRAFFICSOURCE_ADWORDSCLICKINFO,
TRAFFICSOURCE_ADWORDSCLICKINFO_ADGROUPID,
TRAFFICSOURCE_ADWORDSCLICKINFO_ADNETWORKTYPE,
TRAFFICSOURCE_ADWORDSCLICKINFO_CAMPAIGNID,
TRAFFICSOURCE_ADWORDSCLICKINFO_CREATIVEID,
TRAFFICSOURCE_ADWORDSCLICKINFO_CRITERIAID,
TRAFFICSOURCE_ADWORDSCLICKINFO_CRITERIAPARAMETERS,
TRAFFICSOURCE_ADWORDSCLICKINFO_CUSTOMERID,
TRAFFICSOURCE_ADWORDSCLICKINFO_GCLID,
TRAFFICSOURCE_ADWORDSCLICKINFO_ISVIDEOAD,
TRAFFICSOURCE_ADWORDSCLICKINFO_PAGE,
TRAFFICSOURCE_ADWORDSCLICKINFO_SLOT,
TRAFFICSOURCE_ADWORDSCLICKINFO_TARGETINGCRITERIA,
TRAFFICSOURCE_ADWORDSCLICKINFO_TARGETINGCRITERIA_BOOMUSERLISTID,
TRAFFICSOURCE_CAMPAIGN,
TRAFFICSOURCE_CAMPAIGNCODE,
TRAFFICSOURCE_ISTRUEDIRECT,
TRAFFICSOURCE_KEYWORD,
TRAFFICSOURCE_MEDIUM,
TRAFFICSOURCE_REFERRALPATH,
TRAFFICSOURCE_SOURCE,
SOCIALENGAGEMENTTYPE,
CHANNELGROUPING,
DEVICE,
DEVICE_BROWSER,
DEVICE_BROWSERSIZE,
DEVICE_BROWSERVERSION,
DEVICE_DEVICECATEGORY,
DEVICE_MOBILEDEVICEINFO,
DEVICE_MOBILEDEVICEMARKETINGNAME,
DEVICE_MOBILEDEVICEMODEL,
DEVICE_MOBILEINPUTSELECTOR,
DEVICE_OPERATINGSYSTEM,
DEVICE_OPERATINGSYSTEMVERSION,
DEVICE_ISMOBILE,
DEVICE_MOBILEDEVICEBRANDING,
DEVICE_FLASHVERSION,
DEVICE_JAVAENABLED,
DEVICE_LANGUAGE,
DEVICE_SCREENCOLORS,
DEVICE_SCREENRESOLUTION,
CUSTOMDIMENSIONS,
customDimensions.value:index::INT,
customDimensions.value:value::VARCHAR,
GEONETWORK,
GEONETWORK_CONTINENT,
GEONETWORK_SUBCONTINENT,
GEONETWORK_COUNTRY,
GEONETWORK_REGION,
GEONETWORK_METRO,
GEONETWORK_CITY,
GEONETWORK_CITYID,
GEONETWORK_LATITUDE,
GEONETWORK_LONGITUDE,
GEONETWORK_NETWORKDOMAIN,
GEONETWORK_NETWORKLOCATION,
PRIVACY_INFO,
PRIVACY_INFO_ADS_STORAGE,
PRIVACY_INFO_ANALYTICS_STORAGE,
PRIVACY_INFO_USES_TRANSIENT_TOKEN,
HITS,
hits.value:time::INT,
hits.value:dataSource::VARCHAR,
hits.value:referrer::VARCHAR,
hits.value:type::VARCHAR,
hits.value:sourcePropertyInfo::VARIANT,
hits.value:sourcePropertyInfo:sourcePropertyDisplayName::VARCHAR,
hits.value:sourcePropertyInfo:sourcePropertyTrackingId::VARCHAR,
hits.value:eCommerceAction::VARIANT,
hits.value:eCommerceAction:action_type::VARCHAR,
hits.value:eCommerceAction:option::VARCHAR,
hits.value:eCommerceAction:step::INT,
hits.value:exceptionInfo::VARIANT,
hits.value:exceptionInfo:description::VARCHAR,
hits.value:exceptionInfo:isFatal::BOOLEAN,
hits.value:exceptionInfo:exceptions::INT,
hits.value:exceptionInfo:fatalExceptions::INT,
hits.value:hitNumber::INT,
hits.value:hour::INT,
hits.value:isSecure::BOOLEAN,
hits.value:isEntrance::BOOLEAN,
hits.value:isExit::BOOLEAN,
hits.value:isInteraction::BOOLEAN,
hits.value:latencyTracking::VARIANT,
hits.value:latencyTracking:domainLookupTime::INT,
hits.value:latencyTracking:domContentLoadedTime::INT,
hits.value:latencyTracking:domInteractiveTime::INT,
hits.value:latencyTracking:domLatencyMetricsSample::INT,
hits.value:latencyTracking:pageDownloadTime::INT,
hits.value:latencyTracking:pageLoadSample::INT,
hits.value:latencyTracking:pageLoadTime::INT,
hits.value:latencyTracking:redirectionTime::INT,
hits.value:latencyTracking:serverConnectionTime::INT,
hits.value:latencyTracking:serverResponseTime::INT,
hits.value:latencyTracking:speedMetricsSample::INT,
hits.value:latencyTracking:userTimingCategory::VARCHAR,
hits.value:latencyTracking:userTimingLabel::VARCHAR,
hits.value:latencyTracking:userTimingSample::INT,
hits.value:latencyTracking:userTimingValue::INT,
hits.value:latencyTracking:userTimingVariable::VARCHAR,
hits.value:minute::INT,
hits.value:page::VARIANT,
hits.value:page:pagePath::VARCHAR,
hits.value:page:pagePathLevel1::VARCHAR,
hits.value:page:pagePathLevel2::VARCHAR,
hits.value:page:pagePathLevel3::VARCHAR,
hits.value:page:pagePathLevel4::VARCHAR,
hits.value:page:hostname::VARCHAR,
hits.value:page:pageTitle::VARCHAR,
hits.value:page:searchKeyword::VARCHAR,
hits.value:page:searchCategory::VARCHAR,
hits.value:transaction::VARIANT,
hits.value:transaction:transactionId::VARCHAR,
hits.value:transaction:transactionRevenue::INT,
hits.value:transaction:transactionTax::INT,
hits.value:transaction:transactionShipping::INT,
hits.value:transaction:affiliation::VARCHAR,
hits.value:transaction:currencyCode::VARCHAR,
hits.value:transaction:localTransactionRevenue::INT,
hits.value:transaction:localTransactionTax::INT,
hits.value:transaction:localTransactionShipping::INT,
hits.value:transaction:transactionCoupon::VARCHAR,
hits.value:item::VARIANT,
hits.value:item:transactionId::VARCHAR,
hits.value:item:productName::VARCHAR,
hits.value:item:productCategory::VARCHAR,
hits.value:item:productSku::VARCHAR,
hits.value:item:itemQuantity::INT,
hits.value:item:itemRevenue::INT,
hits.value:item:currencyCode::VARCHAR,
hits.value:item:localItemRevenue::INT,
hits.value:contentInfo::VARIANT,
hits.value:contentInfo:contentDescription::VARCHAR,
hits.value:appInfo::VARIANT,
hits.value:appInfo:appInstallerId::VARCHAR,
hits.value:appInfo:appName::VARCHAR,
hits.value:appInfo:appVersion::VARCHAR,
hits.value:appInfo:appId::VARCHAR,
hits.value:appInfo:screenName::VARCHAR,
hits.value:appInfo:landingScreenName::VARCHAR,
hits.value:appInfo:exitScreenName::VARCHAR,
hits.value:appInfo:screenDepth::VARCHAR,
hits.value:eventInfo::VARIANT,
hits.value:eventInfo:eventCategory::VARCHAR,
hits.value:eventInfo:eventAction::VARCHAR,
hits.value:eventInfo:eventLabel::VARCHAR,
hits.value:eventInfo:eventValue::INT,
hits.value:promotion::VARIANT,
hits_promotion.value:promoCreative::VARCHAR,
hits_promotion.value:promoId::VARCHAR,
hits_promotion.value:promoName::VARCHAR,
hits_promotion.value:promoPosition::VARCHAR,
hits.value:promotionActionInfo::VARIANT,
hits.value:promotionActionInfo:promoIsView::BOOLEAN,
hits.value:promotionActionInfo:promoIsClick::BOOLEAN,
hits.value:refund::VARIANT,
hits.value:refund:localRefundAmount::INT,
hits.value:refund:refundAmount::INT,
hits.value:experiment::VARIANT,
hits_experiment.value:experimentId::VARCHAR,
hits_experiment.value:experimentVariant::VARCHAR,
hits.value:publisher::VARIANT,
hits.value:publisher:adsenseBackfillDfpClicks::INT,
hits.value:publisher:adsenseBackfillDfpImpressions::INT,
hits.value:publisher:adsenseBackfillDfpMatchedQueries::INT,
hits.value:publisher:adsenseBackfillDfpMeasurableImpressions::INT,
hits.value:publisher:adsenseBackfillDfpPagesViewed::INT,
hits.value:publisher:adsenseBackfillDfpQueries::INT,
hits.value:publisher:adsenseBackfillDfpRevenueCpc::INT,
hits.value:publisher:adsenseBackfillDfpRevenueCpm::INT,
hits.value:publisher:adsenseBackfillDfpViewableImpressions::INT,
hits.value:publisher:adxBackfillDfpClicks::INT,
hits.value:publisher:adxBackfillDfpImpressions::INT,
hits.value:publisher:adxBackfillDfpMatchedQueries::INT,
hits.value:publisher:adxBackfillDfpMeasurableImpressions::INT,
hits.value:publisher:adxBackfillDfpPagesViewed::INT,
hits.value:publisher:adxBackfillDfpQueries::INT,
hits.value:publisher:adxBackfillDfpRevenueCpc::INT,
hits.value:publisher:adxBackfillDfpRevenueCpm::INT,
hits.value:publisher:adxBackfillDfpViewableImpressions::INT,
hits.value:publisher:dfpAdGroup::VARCHAR,
hits.value:publisher:dfpAdUnits::VARCHAR,
hits.value:publisher:dfpClicks::INT,
hits.value:publisher:dfpImpressions::INT,
hits.value:publisher:dfpMatchedQueries::INT,
hits.value:publisher:dfpMeasurableImpressions::INT,
hits.value:publisher:dfpNetworkId::VARCHAR,
hits.value:publisher:dfpPagesViewed::INT,
hits.value:publisher:dfpQueries::INT,
hits.value:publisher:dfpRevenueCpc::INT,
hits.value:publisher:dfpRevenueCpm::INT,
hits.value:publisher:dfpViewableImpressions::INT,
hits.value:customVariables::VARIANT,
hits_customVariables.value:index::INT,
hits_customVariables.value:customVarName::VARCHAR,
hits_customVariables.value:customVarValue::VARCHAR,
hits.value:customDimensions::VARIANT,
hits_customDimensions.value:index::INT,
hits_customDimensions.value:value::VARCHAR,
hits.value:customMetrics::VARIANT,
hits_customMetrics.value:index::INT,
hits_customMetrics.value:value::INT,
hits.value:social::VARIANT,
hits.value:social:hasSocialSourceReferral::VARCHAR,
hits.value:social:socialInteractionAction::VARCHAR,
hits.value:social:socialInteractionNetwork::VARCHAR,
hits.value:social:socialInteractionNetworkAction::VARCHAR,
hits.value:social:socialInteractions::INT,
hits.value:social:socialInteractionTarget::VARCHAR,
hits.value:social:socialNetwork::VARCHAR,
hits.value:social:uniqueSocialInteractions::INT,
hits.value:contentGroup::VARIANT,
hits.value:contentGroup:contentGroupUniqueViews2::VARCHAR,
hits.value:contentGroup:contentGroup1::VARCHAR,
hits.value:contentGroup:contentGroup2::VARCHAR,
hits.value:contentGroup:contentGroup3::VARCHAR,
hits.value:contentGroup:contentGroup4::VARCHAR,
hits.value:contentGroup:contentGroup5::VARCHAR,
hits.value:contentGroup:previousContentGroup1::VARCHAR,
hits.value:contentGroup:previousContentGroup2::VARCHAR,
hits.value:contentGroup:previousContentGroup3::VARCHAR,
hits.value:contentGroup:previousContentGroup4::VARCHAR,
hits.value:contentGroup:previousContentGroup5::VARCHAR,
hits_product.value:customDimensions::VARIANT,
hits_product_customDimensions.value:index::INT,
hits_product_customDimensions.value:value::VARCHAR,
hits.value:product::VARIANT,
hits_product.value:localProductPrice::INT,
hits_product.value:localProductRefundAmount::INT,
hits_product.value:localProductRevenue::INT,
hits_product.value:productBrand::VARCHAR,
hits_product.value:productPrice::INT,
hits_product.value:productQuantity::INT,
hits_product.value:productRefundAmount::INT,
hits_product.value:productRevenue::INT,
hits_product.value:productSKU::VARCHAR,
hits_product.value:productVariant::VARCHAR,
hits_product.value:v2ProductCategory::VARCHAR,
hits_product.value:v2ProductName::VARCHAR,
hits_product.value:isImpression::BOOLEAN,
hits_product.value:isClick::BOOLEAN,
hits_product.value:productListName::VARCHAR,
hits_product.value:productListPosition::INT



FROM {{ params.stage_db }}.{{ params.raw_schema }}.{{ params.stage_table_compact }} x,
lateral flatten( input => x.hits) as hits,
lateral flatten( input => hits.value:promotion) as hits_promotion,
lateral flatten( input => hits.value:product, outer => true) as hits_product,
lateral flatten( input => x.CUSTOMDIMENSIONS, outer => true) as customDimensions,
lateral flatten( input => hits.value:experiment, outer => true) as hits_experiment,
lateral flatten( input => hits.value:customVariables, outer => true) as hits_customVariables,
lateral flatten( input => hits.value:customDimensions, outer => true) as hits_customDimensions,
lateral flatten( input => hits.value:customMetrics, outer => true) as hits_customMetrics,
lateral flatten( input => hits_product.value:customDimensions, outer => true) as hits_product_customDimensions,
lateral flatten( input => hits_product.value:customMetrics, outer => true) as hits_product_customMetrics;
